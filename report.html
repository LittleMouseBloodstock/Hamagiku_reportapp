<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Monthly Report Generator v8 Final</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Noto+Sans+JP:wght@400;500;700&family=Shippori+Mincho:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- CSS設定 --- */
        :root {
            --primary-color: #1a3c34;
            --accent-color: #c5a059;
            --bg-color: #ffffff;
            --text-main: #333333;
            --text-light: #666666;
            --light-bg: #f4f7f6;
        }
        body.theme-navy { --primary-color: #15202b; --light-bg: #f0f2f5; }
        body { margin: 0; padding: 0; background-color: #e0e0e0; font-family: 'Noto Sans JP', sans-serif; -webkit-print-color-adjust: exact; }
        
        /* 操作パネル */
        .control-panel {
            background: #222; color: #fff; padding: 15px;
            position: sticky; top: 0; z-index: 100;
            display: flex; flex-direction: column; gap: 10px; align-items: center;
        }
        .control-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; justify-content: center; }
        .file-input-wrapper { display: flex; flex-direction: column; align-items: center; }
        .file-label { font-size: 11px; color: #aaa; margin-bottom: 2px; }
        
        select, button, input { padding: 6px 10px; border-radius: 4px; border: none; font-size: 14px; }
        input[type="text"], input[type="password"] { background: #444; color: #fff; border: 1px solid #555; width: 200px; }
        .print-btn { background: var(--accent-color); color: #fff; font-weight: bold; cursor: pointer; padding: 8px 20px; }
        
        /* AIツールバー */
        .ai-tool-area {
            background: #333; padding: 10px; border-radius: 4px; display: flex; gap: 10px; align-items: center;
            border: 1px solid var(--accent-color); margin-top: 5px;
        }
        .ai-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;
        }
        .translate-btn {
            background: #444; border: 1px solid #999; color: white; cursor: pointer; display: flex; align-items: center; gap: 5px;
        }
        .translate-btn:hover { background: #555; }
        .ai-status { font-size: 12px; color: #aaa; margin-left: 10px; }

        /* レポート本体 */
        @page { size: A4; margin: 0; }
        .page {
            width: 210mm; height: 296mm; margin: 20px auto; background: var(--bg-color);
            position: relative; box-sizing: border-box; padding: 40px 50px;
            overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        [contenteditable="true"] { outline: 1px dashed #ccc; transition: outline 0.2s; cursor: text; min-width: 20px; display: inline-block; }
        [contenteditable="true"]:focus { outline: 2px solid var(--accent-color); background: rgba(255,255,200,0.1); }

        /* レイアウト */
        header { display: flex; justify-content: space-between; border-bottom: 2px solid var(--accent-color); padding-bottom: 15px; margin-bottom: 25px; }
        .brand-area { display: flex; align-items: center; }
        .logo-placeholder { max-height: 50px; max-width: 180px; object-fit: contain; margin-right: 10px; }
        .logo-text { font-weight: bold; color: var(--primary-color); letter-spacing: 0.1em; font-size: 18px; }
        .header-title { font-family: 'Cormorant Garamond', serif; font-size: 28px; color: var(--primary-color); }
        
        .horse-profile { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; }
        .horse-name { font-family: 'Shippori Mincho', serif; font-size: 28px; font-weight: 700; }
        .pedigree { font-size: 15px; color: var(--text-light); background: var(--light-bg); padding: 8px 15px; border-left: 3px solid var(--primary-color); }
        .pedigree .label { font-size: 16px; font-weight: 700; margin-right: 4px; }
        
        .main-photo { width: 100%; height: 380px; object-fit: cover; border-radius: 2px; margin-bottom: 25px; object-position: center; background: #eee; }
        
        .data-section { display: flex; gap: 30px; margin-bottom: 25px; height: 220px; }
        .stats-container { flex: 1; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 10px; }
        .stat-box { background: var(--light-bg); padding: 15px; display: flex; flex-direction: column; justify-content: center; border-top: 3px solid #ddd; }
        .stat-box.highlight { border-top-color: var(--accent-color); }
        .stat-label { font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 5px; }
        .stat-value { font-family: 'Cormorant Garamond', serif; font-size: 22px; font-weight: bold; color: var(--primary-color); }
        
        .chart-container { flex: 1.2; position: relative; }
        .section-label { font-size: 12px; font-weight: bold; color: var(--primary-color); margin-bottom: 5px; display: block; border-bottom: 1px solid #ddd; }
        
        .comment-section { border: 1px solid #ddd; padding: 20px; position: relative; background: #fff; min-height: 120px; }
        .comment-title { position: absolute; top: -12px; left: 20px; background: var(--bg-color); padding: 0 10px; font-family: 'Cormorant Garamond', serif; color: var(--primary-color); font-weight: bold; }
        .comment-text { font-size: 13px; line-height: 1.8; text-align: justify; white-space: pre-wrap; }

        footer { position: absolute; bottom: 30px; left: 0; right: 0; text-align: center; font-size: 10px; color: #aaa; font-family: 'Cormorant Garamond', serif; letter-spacing: 0.1em; }

        @media print {
            body { background: none; } .control-panel { display: none; } 
            .page { margin: 0; box-shadow: none; height: 100%; }
            [contenteditable="true"] { outline: none; }
        }
    </style>
</head>
<body class="theme-forest">

    <div class="control-panel">
        <div class="control-row">
            <div>
                <div class="file-label">Settings</div>
                <select id="langSelector" onchange="changeLanguage()">
                    <option value="ja">日本語</option>
                    <option value="en">English</option>
                </select>
                <select id="themeSelector" onchange="changeTheme()">
                    <option value="forest">Forest</option>
                    <option value="navy">Navy</option>
                </select>
            </div>
            
            <div class="file-input-wrapper">
                <div class="file-label">Logo Image</div>
                <input type="file" id="logoInput" accept="image/*" onchange="loadLogo(event)">
            </div>
            
            <div class="file-input-wrapper">
                <div class="file-label" style="color:var(--accent-color); font-weight:bold;">★ Main Photo</div>
                <input type="file" id="mainPhotoInput" accept="image/*" onchange="loadMainPhoto(event)">
            </div>

            <button class="print-btn" onclick="window.print()">PDF出力</button>
        </div>
        
        <div class="control-row ai-tool-area">
            <label style="font-size:12px;">✨ Gemini AI:</label>
            <input type="password" id="apiKey" placeholder="API Key (Optional)">
            <input type="text" id="aiPrompt" placeholder="例: 体重増、動き良し" style="width:200px;">
            <button class="ai-btn" onclick="generateComment()">
                <span>✎ 作成</span>
            </button>
            <button class="translate-btn" onclick="translateComment()">
                <span>⇄ 翻訳 (Translate)</span>
            </button>
            <span id="aiStatus" class="ai-status"></span>
        </div>
    </div>

    <div class="page">
        <header>
            <div class="brand-area">
                <img id="farmLogo" src="" alt="Farm Logo" style="display:none;" class="logo-placeholder">
                <div id="farmNameText" class="logo-text">GEMINI STABLE</div>
            </div>
            <div class="header-title" data-key="report_title">MONTHLY REPORT</div>
        </header>

        <div class="horse-profile">
            <div>
                <div class="horse-name" contenteditable="true">テンコーウィナー</div>
                <span style="font-family:'Cormorant Garamond'; color:var(--accent-color);" contenteditable="true">TENKO WINNER</span>
            </div>
            <div class="pedigree">
                <span data-key="sire" class="label">Sire:</span> <span contenteditable="true">Epiphaneia</span> × <span data-key="dam" class="label">Dam:</span> <span contenteditable="true">Gemini Heroine</span>
            </div>
        </div>

        <img id="mainPhoto" src="https://images.unsplash.com/photo-1551884831-bbf3ddd77535?q=80&w=2070&auto=format&fit=crop" class="main-photo" alt="Horse Photo">

        <div class="data-section">
            <div class="stats-container">
                <div class="stat-box highlight">
                    <span class="stat-label" data-key="weight">Current Weight</span>
                    <span class="stat-value" contenteditable="true">482 kg</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label" data-key="training">Training</span>
                    <span class="stat-value" data-key="training_val" contenteditable="true" style="font-size:16px;">坂路 15-15</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label" data-key="condition">Condition</span>
                    <span class="stat-value" data-key="condition_val" contenteditable="true">Good</span>
                </div>
                <div class="stat-box highlight">
                    <span class="stat-label" data-key="next_race">Target</span>
                    <span class="stat-value" data-key="race_val" contenteditable="true" style="font-size:16px;">3月 中山</span>
                </div>
            </div>
            <div class="chart-container">
                <span class="section-label" data-key="weight_chart">WEIGHT HISTORY</span>
                <canvas id="weightChart"></canvas>
            </div>
        </div>

        <div class="comment-section">
            <span class="comment-title" data-key="comment_header">TRAINER'S COMMENT</span>
            <div class="comment-text" id="commentText" contenteditable="true">
今月は重点的にトモの強化を図り、坂路でのトレーニング強度を上げています。以前に比べ、踏み込みに力強さが出てきました。カイ食いも落ちることなく、馬体重もグラフの通り右肩上がりで、成長分を含めて理想的な数字をキープしています。

気性面でも落ち着きが出てきており、他馬と併せても集中力を切らさずに走れています。来週からは帰厩を視野に入れ、より実戦的なピッチに上げていく予定です。
            </div>
        </div>

        <footer>
            GEMINI STABLE & FARM - FUKUSHIMA, JAPAN | 2026.01.14
        </footer>
    </div>

    <script>
        /* --- 1. 基本設定 (翻訳辞書) --- */
        const translations = {
            ja: {
                report_title: "月次ご報告",
                sire: "父:", dam: "母:",
                weight: "現在の馬体重", training: "調教メニュー", condition: "体調", next_race: "次走目標",
                training_val: "坂路 15-15", condition_val: "良好", race_val: "3月 中山",
                weight_chart: "馬体重の推移",
                comment_header: "調教師コメント",
                // 復活: サンプルコメントの日本語版
                comment_content: "今月は重点的にトモの強化を図り、坂路でのトレーニング強度を上げています。以前に比べ、踏み込みに力強さが出てきました。カイ食いも落ちることなく、馬体重もグラフの通り右肩上がりで、成長分を含めて理想的な数字をキープしています。\n\n気性面でも落ち着きが出てきており、他馬と併せても集中力を切らさずに走れています。来週からは帰厩を視野に入れ、より実戦的なピッチに上げていく予定です。"
            },
            en: {
                report_title: "MONTHLY REPORT",
                sire: "Sire:", dam: "Dam:",
                weight: "Current Weight", training: "Training", condition: "Condition", next_race: "Target",
                training_val: "Hill 15-15", condition_val: "Good", race_val: "Mar. Nakayama",
                weight_chart: "WEIGHT HISTORY",
                comment_header: "TRAINER'S COMMENT",
                // 復活: サンプルコメントの英語版
                comment_content: "We are focusing on strengthening the hindquarters this month. The horse maintains an ideal weight trend as shown in the graph.\n\nMentally, he is becoming calmer and maintains concentration even when working with other horses. From next week, we plan to increase the pace with a view to returning to the training center."
            }
        };

        function changeLanguage() {
            const lang = document.getElementById('langSelector').value;
            const data = translations[lang];
            
            // data-keyを持つ要素を書き換え
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (data[key]) el.innerText = data[key];
            });

            // ★修正: コメントエリアも辞書データで上書き（ただしユーザーが編集中の場合は注意が必要だが、今回はリセットする挙動に戻す）
            if(data.comment_content) {
                document.getElementById('commentText').innerText = data.comment_content;
            }
        }

        /* --- 2. 画像アップロード --- */
        function loadMainPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('mainPhoto').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        function loadLogo(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('farmLogo');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    document.getElementById('farmNameText').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        /* --- 3. Gemini AI 生成 & 翻訳 --- */
        async function callGemini(promptText) {
            const apiKey = document.getElementById('apiKey').value;
            const statusEl = document.getElementById('aiStatus');
            if (!apiKey) {
                alert("API Keyを入力してください");
                return null;
            }
            statusEl.innerText = "Processing...";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                });
                const data = await response.json();
                if (data.error) {
                    statusEl.innerText = "Error: " + data.error.message;
                    return null;
                }
                statusEl.innerText = "Done!";
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                statusEl.innerText = "Network Error";
                console.error(e);
                return null;
            }
        }

        async function generateComment() {
            const promptInput = document.getElementById('aiPrompt').value;
            const lang = document.getElementById('langSelector').value;
            if (!promptInput) { alert("キーワードを入力してください"); return; }
            
            const systemInstruction = lang === 'ja' 
                ? `あなたはプロの競走馬調教師です。以下のキーワードを元に月次レポート用コメントを書いてください。200文字程度。`
                : `You are a racehorse trainer. Write a monthly report comment based on these keywords. Around 100 words.`;
            
            const text = await callGemini(`${systemInstruction}\n\nKeywords: ${promptInput}`);
            if(text) document.getElementById('commentText').innerText = text;
        }

        async function translateComment() {
            const currentText = document.getElementById('commentText').innerText;
            const targetLang = document.getElementById('langSelector').value; // 今選択されている言語に翻訳
            
            const instruction = targetLang === 'ja'
                ? "以下のテキストを、日本の競馬業界の専門用語を使った自然な日本語に翻訳してください。"
                : "Translate the following text into natural English for a horse racing report.";

            const text = await callGemini(`${instruction}\n\nText: ${currentText}`);
            if(text) document.getElementById('commentText').innerText = text;
        }

        /* --- 4. グラフ設定 --- */
        let myChart = null;
        function renderChart(color) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['10月', '11月', '12月', '1月'],
                    datasets: [{
                        label: 'Weight (kg)',
                        data: [468, 472, 478, 482],
                        borderColor: color, backgroundColor: color, borderWidth: 2, pointRadius: 4, tension: 0.1
                    }]
                },
                options: {
                    animation: false, responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: false, min: 450, max: 500, grid: { display: true, borderDash: [5, 5] } }, x: { grid: { display: false } } }
                }
            });
        }

        function changeTheme() {
            const theme = document.getElementById('themeSelector').value;
            const body = document.body;
            if (theme === 'navy') {
                body.classList.remove('theme-forest');
                body.classList.add('theme-navy');
                renderChart('#15202b');
            } else {
                body.classList.remove('theme-navy');
                body.classList.add('theme-forest');
                renderChart('#1a3c34');
            }
        }

        window.onload = function() {
            renderChart('#1a3c34');
            changeLanguage(); // 初期ロード時に辞書の値を反映
        };
    </script>
</body>
</html>